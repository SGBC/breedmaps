---
title: "all_files_GALLO"
author: "Jenny Jakobsson"
date: "2/11/2021"
output: html_document

params: 
  workingDir: "/Users/jj/breedmaps/SVs_identification/"
  annDir: "data/annotation/"
  vcfDir: "data/vcf/"
  gene_file: "Bos_taurus.ARS-UCD1.2.102.gtf"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Install packages (only needs to be run 1 time)
#install.packages("devtools")
#install.packages("vcfR")
#install_github("pablobio/GALLO")
#install.packages("DT")


# Load the packages
library(devtools)
library(vcfR)
library("tidyverse")

```

# Load data
Gene information downloaded from ENSEMBL(ftp://ftp.ensembl.org/pub/release-102/gtf/bos_taurus/). QTL data downloaded from QTLdb(https://www.animalgenome.org/cgi-bin/QTLdb/BT/index) in gff format for reference UMD3.1.

```{r read files}
# Load VCF file
vcf_path = paste(params$workingDir, params$vcfDir, sep="")
vcf_files = list.files(path = vcf_path, pattern="*.vcf")
for (i in 1:length(vcf_files)){
  vcf_file = paste(vcf_path, vcf_files[i], sep="")
  assign(paste("variants_", vcf_files[i], sep=""), vcfR2tidy(read.vcfR(vcf_file, verbose = FALSE), verbose=FALSE)$fix)
}

 
# # Load gene info from ENSEMBL gtf file
# gene_path = paste(params$workingDir, params$annDir, params$gene_file, sep="")
# gene_ann = import_gff_gtf(gene_path, "gtf")

```



# Format data and filter

The files needs to be formatted to get the variant data. I filter out the variants that did not pass the quality control in DELLY.

```{r formatting and filtering}

# Filter out variations that did not pass quality control
filt_variants = variants %>% filter(FILTER=="PASS")

# GALLO needs columns to be called CHR, BP1 and BP2.
filt_variants = filt_variants %>% dplyr::rename(CHR= "CHROM", BP1 = "POS", BP2="END")
```

# Find specific SVs
To more easily get an overview of the data it is split into the SV types. Breakends are not relevant here so only duplications, deletions and inversions are analyzed.

```{r remove break ends}
svs = filt_variants %>% filter(ALT == "<DUP>" | ALT == "<DEL>" | ALT == "<INV>")

```

# GALLO
Using GALLO the QTLs and genes around the variants can be found

```{r gallo}
svs_qtl = find_genes_qtls_around_markers(annotation,
                                         svs,
                                         method = "qtl",
                                         marker = "haplotype",
                                         interval = 0,
                                         nThreads = 1)
# Show subset of data
DT::datatable(svs_qtl[1:100,], rownames = FALSE, extensions = 'FixedColumns', options=list(scrollX = TRUE))

svs_gene = find_genes_qtls_around_markers(gene_ann,
                                          svs,
                                          method = "gene",
                                          marker = "haplotype")

# Show subset of data
DT::datatable(svs_gene[1:100,], rownames = FALSE, extensions = 'FixedColumns', options=list(scrollX = TRUE))

```
## Plotting

```{r plotting}
# Plots the distribution of the trait types
plot = plot_qtl_info(svs_qtl, qtl_plot="qtl_type") %>% title(main="Structural variations", xlab="Trait percentage")

# Performs a QTL enrichment analysis
enrich = qtl_enrich(annotation, svs_qtl, qtl_type="QTL_type", enrich_type="genome")
# Plot the enrichment
enrich_plot = QTLenrich_plot(enrich, "QTL", "pvalue")
enrich_plot
```

